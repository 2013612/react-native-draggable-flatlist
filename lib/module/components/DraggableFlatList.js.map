{"version":3,"names":["React","useCallback","useEffect","useLayoutEffect","useMemo","useRef","useState","FlatList","Gesture","GestureDetector","Animated","runOnJS","useAnimatedReaction","useAnimatedScrollHandler","useSharedValue","withSpring","CellRendererComponent","DEFAULT_PROPS","PlaceholderItem","RowItem","PropsProvider","AnimatedValueProvider","useAnimatedValues","RefProvider","useRefs","DraggableFlatListProvider","useAutoScroll","useStableCallback","ScrollOffsetListener","typedMemo","AnimatedFlatList","createAnimatedComponent","DraggableFlatListInner","props","cellDataRef","containerRef","flatlistRef","keyToIndexRef","propsRef","animationConfigRef","activeCellOffset","activeCellSize","activeIndexAnim","containerSize","scrollOffset","scrollViewSize","spacerIndexAnim","horizontalAnim","placeholderOffset","touchTranslate","autoScrollDistance","panGestureState","isTouchActiveNative","viewableIndexMin","viewableIndexMax","disabled","enabled","reset","value","setActiveKey","dragHitSlop","scrollEnabled","activationDistance","activationDistanceProp","activeKey","layoutAnimationDisabled","setLayoutAnimationDisabled","current","enableLayoutAnimationExperimental","keyExtractor","item","index","Error","dataRef","data","dataHasChanged","map","join","setTimeout","forEach","d","i","key","set","drag","get","cellData","measurements","offset","size","onDragBegin","undefined","onContainerLayout","nativeEvent","layout","width","height","horizontal","onListContentSizeChange","w","h","onContentSizeChange","onContainerTouchStart","onContainerTouchEnd","extraData","renderItem","panGesture","onRelease","onDragEnd","from","to","newData","splice","onPlaceholderIndexChange","cur","prev","hasMoved","gestureDisabled","Pan","manualActivation","onTouchesMove","evt","state","activate","fail","onBegin","onUpdate","translation","translationX","translationY","onEnd","springTo","onTouchesDown","onTouchesUp","hitSlop","activeOffset","activeOffsetX","activeOffsetY","onScroll","onScrollOffsetChange","scrollHandler","contentOffset","x","y","onViewableItemsChanged","info","viewableIndices","viewableItems","filter","isViewable","min","Math","max","containerStyle","renderPlaceholder","simultaneousHandlers","DraggableFlatList","ref","MemoizedInner","forwardRef"],"sources":["DraggableFlatList.tsx"],"sourcesContent":["import React, {\r\n  useCallback,\r\n  useEffect,\r\n  useLayoutEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n} from \"react\";\r\nimport { ListRenderItem, FlatListProps, LayoutChangeEvent } from \"react-native\";\r\nimport {\r\n  FlatList,\r\n  Gesture,\r\n  GestureDetector,\r\n} from \"react-native-gesture-handler\";\r\nimport Animated, {\r\n  runOnJS,\r\n  useAnimatedReaction,\r\n  useAnimatedScrollHandler,\r\n  useSharedValue,\r\n  withSpring,\r\n} from \"react-native-reanimated\";\r\nimport CellRendererComponent from \"./CellRendererComponent\";\r\nimport { DEFAULT_PROPS, isWeb } from \"../constants\";\r\nimport PlaceholderItem from \"./PlaceholderItem\";\r\nimport RowItem from \"./RowItem\";\r\nimport { DraggableFlatListProps } from \"../types\";\r\nimport PropsProvider from \"../context/propsContext\";\r\nimport AnimatedValueProvider, {\r\n  useAnimatedValues,\r\n} from \"../context/animatedValueContext\";\r\nimport RefProvider, { useRefs } from \"../context/refContext\";\r\nimport DraggableFlatListProvider from \"../context/draggableFlatListContext\";\r\nimport { useAutoScroll } from \"../hooks/useAutoScroll\";\r\nimport { useStableCallback } from \"../hooks/useStableCallback\";\r\nimport ScrollOffsetListener from \"./ScrollOffsetListener\";\r\nimport { typedMemo } from \"../utils\";\r\n\r\ntype RNGHFlatListProps<T> = Animated.AnimateProps<\r\n  FlatListProps<T> & {\r\n    ref: React.Ref<FlatList<T>>;\r\n    simultaneousHandlers?: React.Ref<any> | React.Ref<any>[];\r\n  }\r\n>;\r\n\r\ntype OnViewableItemsChangedCallback<T> = Exclude<\r\n  FlatListProps<T>[\"onViewableItemsChanged\"],\r\n  undefined | null\r\n>;\r\n\r\nconst AnimatedFlatList = (Animated.createAnimatedComponent(\r\n  FlatList\r\n) as unknown) as <T>(props: RNGHFlatListProps<T>) => React.ReactElement;\r\n\r\nfunction DraggableFlatListInner<T>(props: DraggableFlatListProps<T>) {\r\n  const {\r\n    cellDataRef,\r\n    containerRef,\r\n    flatlistRef,\r\n    keyToIndexRef,\r\n    propsRef,\r\n    animationConfigRef,\r\n  } = useRefs<T>();\r\n  const {\r\n    activeCellOffset,\r\n    activeCellSize,\r\n    activeIndexAnim,\r\n    containerSize,\r\n    scrollOffset,\r\n    scrollViewSize,\r\n    spacerIndexAnim,\r\n    horizontalAnim,\r\n    placeholderOffset,\r\n    touchTranslate,\r\n    autoScrollDistance,\r\n    panGestureState,\r\n    isTouchActiveNative,\r\n    viewableIndexMin,\r\n    viewableIndexMax,\r\n    disabled,\r\n  } = useAnimatedValues();\r\n\r\n  const enabled = useSharedValue(false);\r\n\r\n  const reset = useStableCallback(() => {\r\n    activeIndexAnim.value = -1;\r\n    spacerIndexAnim.value = -1;\r\n    touchTranslate.value = 0;\r\n    activeCellSize.value = -1;\r\n    activeCellOffset.value = -1;\r\n    setActiveKey(null);\r\n  });\r\n\r\n  const {\r\n    dragHitSlop = DEFAULT_PROPS.dragHitSlop,\r\n    scrollEnabled = DEFAULT_PROPS.scrollEnabled,\r\n    activationDistance: activationDistanceProp = DEFAULT_PROPS.activationDistance,\r\n  } = props;\r\n\r\n  let [activeKey, setActiveKey] = useState<string | null>(null);\r\n  const [layoutAnimationDisabled, setLayoutAnimationDisabled] = useState(\r\n    !propsRef.current.enableLayoutAnimationExperimental\r\n  );\r\n\r\n  const keyExtractor = useStableCallback((item: T, index: number) => {\r\n    if (!props.keyExtractor) {\r\n      throw new Error(\"You must provide a keyExtractor to DraggableFlatList\");\r\n    }\r\n    return props.keyExtractor(item, index);\r\n  });\r\n\r\n  const dataRef = useRef(props.data);\r\n  const dataHasChanged =\r\n    dataRef.current.map(keyExtractor).join(\"\") !==\r\n    props.data.map(keyExtractor).join(\"\");\r\n  dataRef.current = props.data;\r\n  if (dataHasChanged) {\r\n    // When data changes make sure `activeKey` is nulled out in the same render pass\r\n    activeKey = null;\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (!propsRef.current.enableLayoutAnimationExperimental) return;\r\n    if (activeKey) {\r\n      setLayoutAnimationDisabled(true);\r\n    } else {\r\n      // setTimeout result of trial-and-error to determine how long to wait before\r\n      // re-enabling layout animations so that a drag reorder does not trigger it.\r\n      setTimeout(() => {\r\n        setLayoutAnimationDisabled(false);\r\n      }, 100);\r\n    }\r\n  }, [activeKey]);\r\n\r\n  useLayoutEffect(() => {\r\n    props.data.forEach((d, i) => {\r\n      const key = keyExtractor(d, i);\r\n      keyToIndexRef.current.set(key, i);\r\n    });\r\n  }, [props.data, keyExtractor, keyToIndexRef]);\r\n\r\n  const drag = useStableCallback((activeKey: string) => {\r\n    if (disabled.value) return;\r\n\r\n    const index = keyToIndexRef.current.get(activeKey);\r\n    const cellData = cellDataRef.current.get(activeKey);\r\n    if (cellData) {\r\n      activeCellOffset.value = cellData.measurements.offset;\r\n      activeCellSize.value = cellData.measurements.size;\r\n    }\r\n\r\n    const { onDragBegin } = propsRef.current;\r\n    if (index !== undefined) {\r\n      spacerIndexAnim.value = index;\r\n      activeIndexAnim.value = index;\r\n      setActiveKey(activeKey);\r\n      onDragBegin?.(index);\r\n    }\r\n  });\r\n\r\n  const onContainerLayout = ({\r\n    nativeEvent: { layout },\r\n  }: LayoutChangeEvent) => {\r\n    const { width, height } = layout;\r\n    containerSize.value = props.horizontal ? width : height;\r\n    props.onContainerLayout?.({ layout, containerRef });\r\n  };\r\n\r\n  const onListContentSizeChange = (w: number, h: number) => {\r\n    scrollViewSize.value = props.horizontal ? w : h;\r\n    props.onContentSizeChange?.(w, h);\r\n  };\r\n\r\n  const onContainerTouchStart = () => {\r\n    if (!disabled.value) {\r\n      isTouchActiveNative.value = true;\r\n    }\r\n    return false;\r\n  };\r\n\r\n  const onContainerTouchEnd = () => {\r\n    isTouchActiveNative.value = false;\r\n  };\r\n\r\n  const extraData = useMemo(\r\n    () => ({\r\n      activeKey,\r\n      extraData: props.extraData,\r\n    }),\r\n    [activeKey, props.extraData]\r\n  );\r\n\r\n  const renderItem: ListRenderItem<T> = useCallback(\r\n    ({ item, index }) => {\r\n      const key = keyExtractor(item, index);\r\n      if (index !== keyToIndexRef.current.get(key)) {\r\n        keyToIndexRef.current.set(key, index);\r\n      }\r\n\r\n      return (\r\n        <RowItem\r\n          item={item}\r\n          itemKey={key}\r\n          renderItem={props.renderItem}\r\n          drag={drag}\r\n          enabled={enabled}\r\n          panGesture={panGesture}\r\n          extraData={props.extraData}\r\n        />\r\n      );\r\n    },\r\n    [props.renderItem, props.extraData, drag, keyExtractor]\r\n  );\r\n\r\n  const onRelease = useStableCallback((index: number) => {\r\n    props.onRelease?.(index);\r\n  });\r\n\r\n  const onDragEnd = useStableCallback(\r\n    ({ from, to }: { from: number; to: number }) => {\r\n      const { onDragEnd, data } = props;\r\n\r\n      const newData = [...data];\r\n      if (from !== to) {\r\n        newData.splice(from, 1);\r\n        newData.splice(to, 0, data[from]);\r\n      }\r\n\r\n      onDragEnd?.({ from, to, data: newData });\r\n      reset();\r\n    }\r\n  );\r\n\r\n  const onPlaceholderIndexChange = useStableCallback((index: number) => {\r\n    props.onPlaceholderIndexChange?.(index);\r\n  });\r\n\r\n  // Handle case where user ends drag without moving their finger.\r\n  useAnimatedReaction(\r\n    () => {\r\n      return isTouchActiveNative.value;\r\n    },\r\n    (cur, prev) => {\r\n      if (cur !== prev && !cur) {\r\n        const hasMoved = !!touchTranslate.value;\r\n        if (!hasMoved && activeIndexAnim.value >= 0 && !disabled.value) {\r\n          runOnJS(onRelease)(activeIndexAnim.value);\r\n          runOnJS(onDragEnd)({\r\n            from: activeIndexAnim.value,\r\n            to: spacerIndexAnim.value,\r\n          });\r\n        }\r\n      }\r\n    },\r\n    [isTouchActiveNative, onDragEnd, onRelease]\r\n  );\r\n\r\n  useAnimatedReaction(\r\n    () => {\r\n      return spacerIndexAnim.value;\r\n    },\r\n    (cur, prev) => {\r\n      if (prev !== null && cur !== prev && cur >= 0 && prev >= 0) {\r\n        runOnJS(onPlaceholderIndexChange)(cur);\r\n      }\r\n    },\r\n    [spacerIndexAnim]\r\n  );\r\n\r\n  const gestureDisabled = useSharedValue(false);\r\n\r\n  const panGesture = Gesture.Pan()\r\n    .manualActivation(true)\r\n    .onTouchesMove((evt, state) => {\r\n      if (enabled.value) {\r\n        state.activate();\r\n      } else {\r\n        state.fail();\r\n      }\r\n    })\r\n    .onBegin((evt) => {\r\n      gestureDisabled.value = disabled.value;\r\n      if (gestureDisabled.value) return;\r\n      panGestureState.value = evt.state;\r\n    })\r\n    .onUpdate((evt) => {\r\n      if (gestureDisabled.value) return;\r\n      panGestureState.value = evt.state;\r\n      const translation = horizontalAnim.value\r\n        ? evt.translationX\r\n        : evt.translationY;\r\n      touchTranslate.value = translation;\r\n    })\r\n    .onEnd((evt) => {\r\n      if (gestureDisabled.value) return;\r\n      // Set touch val to current translate val\r\n      isTouchActiveNative.value = false;\r\n      const translation = horizontalAnim.value\r\n        ? evt.translationX\r\n        : evt.translationY;\r\n\r\n      touchTranslate.value = translation + autoScrollDistance.value;\r\n      panGestureState.value = evt.state;\r\n\r\n      // Only call onDragEnd if actually dragging a cell\r\n      if (activeIndexAnim.value === -1 || disabled.value) return;\r\n      disabled.value = true;\r\n      runOnJS(onRelease)(activeIndexAnim.value);\r\n      const springTo = placeholderOffset.value - activeCellOffset.value;\r\n      touchTranslate.value = withSpring(\r\n        springTo,\r\n        animationConfigRef.current,\r\n        () => {\r\n          runOnJS(onDragEnd)({\r\n            from: activeIndexAnim.value,\r\n            to: spacerIndexAnim.value,\r\n          });\r\n          disabled.value = false;\r\n        }\r\n      );\r\n    })\r\n    .onTouchesDown(() => {\r\n      runOnJS(onContainerTouchStart)();\r\n    })\r\n    .onTouchesUp(() => {\r\n      // Turning this into a worklet causes timing issues. We want it to run\r\n      // just after the finger lifts.\r\n      enabled.value = false;\r\n      runOnJS(onContainerTouchEnd)();\r\n    });\r\n\r\n  if (dragHitSlop) panGesture.hitSlop(dragHitSlop);\r\n  if (activationDistanceProp) {\r\n    const activeOffset = [-activationDistanceProp, activationDistanceProp];\r\n    if (props.horizontal) {\r\n      panGesture.activeOffsetX(activeOffset);\r\n    } else {\r\n      panGesture.activeOffsetY(activeOffset);\r\n    }\r\n  }\r\n\r\n  const onScroll = useStableCallback((scrollOffset: number) => {\r\n    props.onScrollOffsetChange?.(scrollOffset);\r\n  });\r\n\r\n  const scrollHandler = useAnimatedScrollHandler(\r\n    {\r\n      onScroll: (evt) => {\r\n        scrollOffset.value = horizontalAnim.value\r\n          ? evt.contentOffset.x\r\n          : evt.contentOffset.y;\r\n        runOnJS(onScroll)(scrollOffset.value);\r\n      },\r\n    },\r\n    [horizontalAnim]\r\n  );\r\n\r\n  useAutoScroll();\r\n\r\n  const onViewableItemsChanged = useStableCallback<\r\n    OnViewableItemsChangedCallback<T>\r\n  >((info) => {\r\n    const viewableIndices = info.viewableItems\r\n      .filter((item) => item.isViewable)\r\n      .map((item) => item.index)\r\n      .filter((index): index is number => typeof index === \"number\");\r\n\r\n    const min = Math.min(...viewableIndices);\r\n    const max = Math.max(...viewableIndices);\r\n    viewableIndexMin.value = min;\r\n    viewableIndexMax.value = max;\r\n    props.onViewableItemsChanged?.(info);\r\n  });\r\n\r\n  return (\r\n    <DraggableFlatListProvider\r\n      activeKey={activeKey}\r\n      keyExtractor={keyExtractor}\r\n      horizontal={!!props.horizontal}\r\n      layoutAnimationDisabled={layoutAnimationDisabled}\r\n    >\r\n      <GestureDetector gesture={panGesture}>\r\n        <Animated.View\r\n          style={props.containerStyle}\r\n          ref={containerRef}\r\n          onLayout={onContainerLayout}\r\n        >\r\n          {props.renderPlaceholder && (\r\n            <PlaceholderItem renderPlaceholder={props.renderPlaceholder} />\r\n          )}\r\n          <AnimatedFlatList\r\n            {...props}\r\n            data={props.data}\r\n            onViewableItemsChanged={onViewableItemsChanged}\r\n            CellRendererComponent={CellRendererComponent}\r\n            ref={flatlistRef}\r\n            onContentSizeChange={onListContentSizeChange}\r\n            scrollEnabled={!activeKey && scrollEnabled}\r\n            renderItem={renderItem}\r\n            extraData={extraData}\r\n            keyExtractor={keyExtractor}\r\n            onScroll={scrollHandler}\r\n            scrollEventThrottle={16}\r\n            simultaneousHandlers={props.simultaneousHandlers}\r\n            removeClippedSubviews={false}\r\n          />\r\n          {!!props.onScrollOffsetChange && (\r\n            <ScrollOffsetListener\r\n              onScrollOffsetChange={props.onScrollOffsetChange}\r\n              scrollOffset={scrollOffset}\r\n            />\r\n          )}\r\n        </Animated.View>\r\n      </GestureDetector>\r\n    </DraggableFlatListProvider>\r\n  );\r\n}\r\n\r\nfunction DraggableFlatList<T>(\r\n  props: DraggableFlatListProps<T>,\r\n  ref?: React.ForwardedRef<FlatList<T>> | null\r\n) {\r\n  return (\r\n    <PropsProvider {...props}>\r\n      <AnimatedValueProvider>\r\n        <RefProvider flatListRef={ref}>\r\n          <MemoizedInner {...props} />\r\n        </RefProvider>\r\n      </AnimatedValueProvider>\r\n    </PropsProvider>\r\n  );\r\n}\r\n\r\nconst MemoizedInner = typedMemo(DraggableFlatListInner);\r\n\r\n// Generic forwarded ref type assertion taken from:\r\n// https://fettblog.eu/typescript-react-generic-forward-refs/#option-1%3A-type-assertion\r\nexport default React.forwardRef(DraggableFlatList) as <T>(\r\n  props: DraggableFlatListProps<T> & { ref?: React.ForwardedRef<FlatList<T>> }\r\n) => ReturnType<typeof DraggableFlatList>;\r\n"],"mappings":";;AAAA,OAAOA,KAAP,IACEC,WADF,EAEEC,SAFF,EAGEC,eAHF,EAIEC,OAJF,EAKEC,MALF,EAMEC,QANF,QAOO,OAPP;AASA,SACEC,QADF,EAEEC,OAFF,EAGEC,eAHF,QAIO,8BAJP;AAKA,OAAOC,QAAP,IACEC,OADF,EAEEC,mBAFF,EAGEC,wBAHF,EAIEC,cAJF,EAKEC,UALF,QAMO,yBANP;AAOA,OAAOC,qBAAP,MAAkC,yBAAlC;AACA,SAASC,aAAT,QAAqC,cAArC;AACA,OAAOC,eAAP,MAA4B,mBAA5B;AACA,OAAOC,OAAP,MAAoB,WAApB;AAEA,OAAOC,aAAP,MAA0B,yBAA1B;AACA,OAAOC,qBAAP,IACEC,iBADF,QAEO,iCAFP;AAGA,OAAOC,WAAP,IAAsBC,OAAtB,QAAqC,uBAArC;AACA,OAAOC,yBAAP,MAAsC,qCAAtC;AACA,SAASC,aAAT,QAA8B,wBAA9B;AACA,SAASC,iBAAT,QAAkC,4BAAlC;AACA,OAAOC,oBAAP,MAAiC,wBAAjC;AACA,SAASC,SAAT,QAA0B,UAA1B;AAcA,MAAMC,gBAAgB,GAAIpB,QAAQ,CAACqB,uBAAT,CACxBxB,QADwB,CAA1B;;AAIA,SAASyB,sBAAT,CAAmCC,KAAnC,EAAqE;EACnE,MAAM;IACJC,WADI;IAEJC,YAFI;IAGJC,WAHI;IAIJC,aAJI;IAKJC,QALI;IAMJC;EANI,IAOFf,OAAO,EAPX;EAQA,MAAM;IACJgB,gBADI;IAEJC,cAFI;IAGJC,eAHI;IAIJC,aAJI;IAKJC,YALI;IAMJC,cANI;IAOJC,eAPI;IAQJC,cARI;IASJC,iBATI;IAUJC,cAVI;IAWJC,kBAXI;IAYJC,eAZI;IAaJC,mBAbI;IAcJC,gBAdI;IAeJC,gBAfI;IAgBJC;EAhBI,IAiBFjC,iBAAiB,EAjBrB;EAmBA,MAAMkC,OAAO,GAAG1C,cAAc,CAAC,KAAD,CAA9B;EAEA,MAAM2C,KAAK,GAAG9B,iBAAiB,CAAC,MAAM;IACpCe,eAAe,CAACgB,KAAhB,GAAwB,CAAC,CAAzB;IACAZ,eAAe,CAACY,KAAhB,GAAwB,CAAC,CAAzB;IACAT,cAAc,CAACS,KAAf,GAAuB,CAAvB;IACAjB,cAAc,CAACiB,KAAf,GAAuB,CAAC,CAAxB;IACAlB,gBAAgB,CAACkB,KAAjB,GAAyB,CAAC,CAA1B;IACAC,YAAY,CAAC,IAAD,CAAZ;EACD,CAP8B,CAA/B;EASA,MAAM;IACJC,WAAW,GAAG3C,aAAa,CAAC2C,WADxB;IAEJC,aAAa,GAAG5C,aAAa,CAAC4C,aAF1B;IAGJC,kBAAkB,EAAEC,sBAAsB,GAAG9C,aAAa,CAAC6C;EAHvD,IAIF7B,KAJJ;EAMA,IAAI,CAAC+B,SAAD,EAAYL,YAAZ,IAA4BrD,QAAQ,CAAgB,IAAhB,CAAxC;EACA,MAAM,CAAC2D,uBAAD,EAA0BC,0BAA1B,IAAwD5D,QAAQ,CACpE,CAACgC,QAAQ,CAAC6B,OAAT,CAAiBC,iCADkD,CAAtE;EAIA,MAAMC,YAAY,GAAG1C,iBAAiB,CAAC,CAAC2C,IAAD,EAAUC,KAAV,KAA4B;IACjE,IAAI,CAACtC,KAAK,CAACoC,YAAX,EAAyB;MACvB,MAAM,IAAIG,KAAJ,CAAU,sDAAV,CAAN;IACD;;IACD,OAAOvC,KAAK,CAACoC,YAAN,CAAmBC,IAAnB,EAAyBC,KAAzB,CAAP;EACD,CALqC,CAAtC;EAOA,MAAME,OAAO,GAAGpE,MAAM,CAAC4B,KAAK,CAACyC,IAAP,CAAtB;EACA,MAAMC,cAAc,GAClBF,OAAO,CAACN,OAAR,CAAgBS,GAAhB,CAAoBP,YAApB,EAAkCQ,IAAlC,CAAuC,EAAvC,MACA5C,KAAK,CAACyC,IAAN,CAAWE,GAAX,CAAeP,YAAf,EAA6BQ,IAA7B,CAAkC,EAAlC,CAFF;EAGAJ,OAAO,CAACN,OAAR,GAAkBlC,KAAK,CAACyC,IAAxB;;EACA,IAAIC,cAAJ,EAAoB;IAClB;IACAX,SAAS,GAAG,IAAZ;EACD;;EAED9D,SAAS,CAAC,MAAM;IACd,IAAI,CAACoC,QAAQ,CAAC6B,OAAT,CAAiBC,iCAAtB,EAAyD;;IACzD,IAAIJ,SAAJ,EAAe;MACbE,0BAA0B,CAAC,IAAD,CAA1B;IACD,CAFD,MAEO;MACL;MACA;MACAY,UAAU,CAAC,MAAM;QACfZ,0BAA0B,CAAC,KAAD,CAA1B;MACD,CAFS,EAEP,GAFO,CAAV;IAGD;EACF,CAXQ,EAWN,CAACF,SAAD,CAXM,CAAT;EAaA7D,eAAe,CAAC,MAAM;IACpB8B,KAAK,CAACyC,IAAN,CAAWK,OAAX,CAAmB,CAACC,CAAD,EAAIC,CAAJ,KAAU;MAC3B,MAAMC,GAAG,GAAGb,YAAY,CAACW,CAAD,EAAIC,CAAJ,CAAxB;MACA5C,aAAa,CAAC8B,OAAd,CAAsBgB,GAAtB,CAA0BD,GAA1B,EAA+BD,CAA/B;IACD,CAHD;EAID,CALc,EAKZ,CAAChD,KAAK,CAACyC,IAAP,EAAaL,YAAb,EAA2BhC,aAA3B,CALY,CAAf;EAOA,MAAM+C,IAAI,GAAGzD,iBAAiB,CAAEqC,SAAD,IAAuB;IACpD,IAAIT,QAAQ,CAACG,KAAb,EAAoB;IAEpB,MAAMa,KAAK,GAAGlC,aAAa,CAAC8B,OAAd,CAAsBkB,GAAtB,CAA0BrB,SAA1B,CAAd;IACA,MAAMsB,QAAQ,GAAGpD,WAAW,CAACiC,OAAZ,CAAoBkB,GAApB,CAAwBrB,SAAxB,CAAjB;;IACA,IAAIsB,QAAJ,EAAc;MACZ9C,gBAAgB,CAACkB,KAAjB,GAAyB4B,QAAQ,CAACC,YAAT,CAAsBC,MAA/C;MACA/C,cAAc,CAACiB,KAAf,GAAuB4B,QAAQ,CAACC,YAAT,CAAsBE,IAA7C;IACD;;IAED,MAAM;MAAEC;IAAF,IAAkBpD,QAAQ,CAAC6B,OAAjC;;IACA,IAAII,KAAK,KAAKoB,SAAd,EAAyB;MACvB7C,eAAe,CAACY,KAAhB,GAAwBa,KAAxB;MACA7B,eAAe,CAACgB,KAAhB,GAAwBa,KAAxB;MACAZ,YAAY,CAACK,SAAD,CAAZ;MACA0B,WAAW,SAAX,IAAAA,WAAW,WAAX,YAAAA,WAAW,CAAGnB,KAAH,CAAX;IACD;EACF,CAjB6B,CAA9B;;EAmBA,MAAMqB,iBAAiB,GAAG,QAED;IAAA;;IAAA,IAFE;MACzBC,WAAW,EAAE;QAAEC;MAAF;IADY,CAEF;IACvB,MAAM;MAAEC,KAAF;MAASC;IAAT,IAAoBF,MAA1B;IACAnD,aAAa,CAACe,KAAd,GAAsBzB,KAAK,CAACgE,UAAN,GAAmBF,KAAnB,GAA2BC,MAAjD;IACA,yBAAA/D,KAAK,CAAC2D,iBAAN,qFAAA3D,KAAK,EAAqB;MAAE6D,MAAF;MAAU3D;IAAV,CAArB,CAAL;EACD,CAND;;EAQA,MAAM+D,uBAAuB,GAAG,CAACC,CAAD,EAAYC,CAAZ,KAA0B;IAAA;;IACxDvD,cAAc,CAACa,KAAf,GAAuBzB,KAAK,CAACgE,UAAN,GAAmBE,CAAnB,GAAuBC,CAA9C;IACA,yBAAAnE,KAAK,CAACoE,mBAAN,qFAAApE,KAAK,EAAuBkE,CAAvB,EAA0BC,CAA1B,CAAL;EACD,CAHD;;EAKA,MAAME,qBAAqB,GAAG,MAAM;IAClC,IAAI,CAAC/C,QAAQ,CAACG,KAAd,EAAqB;MACnBN,mBAAmB,CAACM,KAApB,GAA4B,IAA5B;IACD;;IACD,OAAO,KAAP;EACD,CALD;;EAOA,MAAM6C,mBAAmB,GAAG,MAAM;IAChCnD,mBAAmB,CAACM,KAApB,GAA4B,KAA5B;EACD,CAFD;;EAIA,MAAM8C,SAAS,GAAGpG,OAAO,CACvB,OAAO;IACL4D,SADK;IAELwC,SAAS,EAAEvE,KAAK,CAACuE;EAFZ,CAAP,CADuB,EAKvB,CAACxC,SAAD,EAAY/B,KAAK,CAACuE,SAAlB,CALuB,CAAzB;EAQA,MAAMC,UAA6B,GAAGxG,WAAW,CAC/C,SAAqB;IAAA,IAApB;MAAEqE,IAAF;MAAQC;IAAR,CAAoB;IACnB,MAAMW,GAAG,GAAGb,YAAY,CAACC,IAAD,EAAOC,KAAP,CAAxB;;IACA,IAAIA,KAAK,KAAKlC,aAAa,CAAC8B,OAAd,CAAsBkB,GAAtB,CAA0BH,GAA1B,CAAd,EAA8C;MAC5C7C,aAAa,CAAC8B,OAAd,CAAsBgB,GAAtB,CAA0BD,GAA1B,EAA+BX,KAA/B;IACD;;IAED,oBACE,oBAAC,OAAD;MACE,IAAI,EAAED,IADR;MAEE,OAAO,EAAEY,GAFX;MAGE,UAAU,EAAEjD,KAAK,CAACwE,UAHpB;MAIE,IAAI,EAAErB,IAJR;MAKE,OAAO,EAAE5B,OALX;MAME,UAAU,EAAEkD,UANd;MAOE,SAAS,EAAEzE,KAAK,CAACuE;IAPnB,EADF;EAWD,CAlB8C,EAmB/C,CAACvE,KAAK,CAACwE,UAAP,EAAmBxE,KAAK,CAACuE,SAAzB,EAAoCpB,IAApC,EAA0Cf,YAA1C,CAnB+C,CAAjD;EAsBA,MAAMsC,SAAS,GAAGhF,iBAAiB,CAAE4C,KAAD,IAAmB;IAAA;;IACrD,oBAAAtC,KAAK,CAAC0E,SAAN,2EAAA1E,KAAK,EAAasC,KAAb,CAAL;EACD,CAFkC,CAAnC;EAIA,MAAMqC,SAAS,GAAGjF,iBAAiB,CACjC,SAAgD;IAAA,IAA/C;MAAEkF,IAAF;MAAQC;IAAR,CAA+C;IAC9C,MAAM;MAAEF,SAAF;MAAalC;IAAb,IAAsBzC,KAA5B;IAEA,MAAM8E,OAAO,GAAG,CAAC,GAAGrC,IAAJ,CAAhB;;IACA,IAAImC,IAAI,KAAKC,EAAb,EAAiB;MACfC,OAAO,CAACC,MAAR,CAAeH,IAAf,EAAqB,CAArB;MACAE,OAAO,CAACC,MAAR,CAAeF,EAAf,EAAmB,CAAnB,EAAsBpC,IAAI,CAACmC,IAAD,CAA1B;IACD;;IAEDD,SAAS,SAAT,IAAAA,SAAS,WAAT,YAAAA,SAAS,CAAG;MAAEC,IAAF;MAAQC,EAAR;MAAYpC,IAAI,EAAEqC;IAAlB,CAAH,CAAT;IACAtD,KAAK;EACN,CAZgC,CAAnC;EAeA,MAAMwD,wBAAwB,GAAGtF,iBAAiB,CAAE4C,KAAD,IAAmB;IAAA;;IACpE,yBAAAtC,KAAK,CAACgF,wBAAN,qFAAAhF,KAAK,EAA4BsC,KAA5B,CAAL;EACD,CAFiD,CAAlD,CAnLmE,CAuLnE;;EACA3D,mBAAmB,CACjB,MAAM;IACJ,OAAOwC,mBAAmB,CAACM,KAA3B;EACD,CAHgB,EAIjB,CAACwD,GAAD,EAAMC,IAAN,KAAe;IACb,IAAID,GAAG,KAAKC,IAAR,IAAgB,CAACD,GAArB,EAA0B;MACxB,MAAME,QAAQ,GAAG,CAAC,CAACnE,cAAc,CAACS,KAAlC;;MACA,IAAI,CAAC0D,QAAD,IAAa1E,eAAe,CAACgB,KAAhB,IAAyB,CAAtC,IAA2C,CAACH,QAAQ,CAACG,KAAzD,EAAgE;QAC9D/C,OAAO,CAACgG,SAAD,CAAP,CAAmBjE,eAAe,CAACgB,KAAnC;QACA/C,OAAO,CAACiG,SAAD,CAAP,CAAmB;UACjBC,IAAI,EAAEnE,eAAe,CAACgB,KADL;UAEjBoD,EAAE,EAAEhE,eAAe,CAACY;QAFH,CAAnB;MAID;IACF;EACF,CAfgB,EAgBjB,CAACN,mBAAD,EAAsBwD,SAAtB,EAAiCD,SAAjC,CAhBiB,CAAnB;EAmBA/F,mBAAmB,CACjB,MAAM;IACJ,OAAOkC,eAAe,CAACY,KAAvB;EACD,CAHgB,EAIjB,CAACwD,GAAD,EAAMC,IAAN,KAAe;IACb,IAAIA,IAAI,KAAK,IAAT,IAAiBD,GAAG,KAAKC,IAAzB,IAAiCD,GAAG,IAAI,CAAxC,IAA6CC,IAAI,IAAI,CAAzD,EAA4D;MAC1DxG,OAAO,CAACsG,wBAAD,CAAP,CAAkCC,GAAlC;IACD;EACF,CARgB,EASjB,CAACpE,eAAD,CATiB,CAAnB;EAYA,MAAMuE,eAAe,GAAGvG,cAAc,CAAC,KAAD,CAAtC;EAEA,MAAM4F,UAAU,GAAGlG,OAAO,CAAC8G,GAAR,GAChBC,gBADgB,CACC,IADD,EAEhBC,aAFgB,CAEF,CAACC,GAAD,EAAMC,KAAN,KAAgB;IAC7B,IAAIlE,OAAO,CAACE,KAAZ,EAAmB;MACjBgE,KAAK,CAACC,QAAN;IACD,CAFD,MAEO;MACLD,KAAK,CAACE,IAAN;IACD;EACF,CARgB,EAShBC,OATgB,CASPJ,GAAD,IAAS;IAChBJ,eAAe,CAAC3D,KAAhB,GAAwBH,QAAQ,CAACG,KAAjC;IACA,IAAI2D,eAAe,CAAC3D,KAApB,EAA2B;IAC3BP,eAAe,CAACO,KAAhB,GAAwB+D,GAAG,CAACC,KAA5B;EACD,CAbgB,EAchBI,QAdgB,CAcNL,GAAD,IAAS;IACjB,IAAIJ,eAAe,CAAC3D,KAApB,EAA2B;IAC3BP,eAAe,CAACO,KAAhB,GAAwB+D,GAAG,CAACC,KAA5B;IACA,MAAMK,WAAW,GAAGhF,cAAc,CAACW,KAAf,GAChB+D,GAAG,CAACO,YADY,GAEhBP,GAAG,CAACQ,YAFR;IAGAhF,cAAc,CAACS,KAAf,GAAuBqE,WAAvB;EACD,CArBgB,EAsBhBG,KAtBgB,CAsBTT,GAAD,IAAS;IACd,IAAIJ,eAAe,CAAC3D,KAApB,EAA2B,OADb,CAEd;;IACAN,mBAAmB,CAACM,KAApB,GAA4B,KAA5B;IACA,MAAMqE,WAAW,GAAGhF,cAAc,CAACW,KAAf,GAChB+D,GAAG,CAACO,YADY,GAEhBP,GAAG,CAACQ,YAFR;IAIAhF,cAAc,CAACS,KAAf,GAAuBqE,WAAW,GAAG7E,kBAAkB,CAACQ,KAAxD;IACAP,eAAe,CAACO,KAAhB,GAAwB+D,GAAG,CAACC,KAA5B,CATc,CAWd;;IACA,IAAIhF,eAAe,CAACgB,KAAhB,KAA0B,CAAC,CAA3B,IAAgCH,QAAQ,CAACG,KAA7C,EAAoD;IACpDH,QAAQ,CAACG,KAAT,GAAiB,IAAjB;IACA/C,OAAO,CAACgG,SAAD,CAAP,CAAmBjE,eAAe,CAACgB,KAAnC;IACA,MAAMyE,QAAQ,GAAGnF,iBAAiB,CAACU,KAAlB,GAA0BlB,gBAAgB,CAACkB,KAA5D;IACAT,cAAc,CAACS,KAAf,GAAuB3C,UAAU,CAC/BoH,QAD+B,EAE/B5F,kBAAkB,CAAC4B,OAFY,EAG/B,MAAM;MACJxD,OAAO,CAACiG,SAAD,CAAP,CAAmB;QACjBC,IAAI,EAAEnE,eAAe,CAACgB,KADL;QAEjBoD,EAAE,EAAEhE,eAAe,CAACY;MAFH,CAAnB;MAIAH,QAAQ,CAACG,KAAT,GAAiB,KAAjB;IACD,CAT8B,CAAjC;EAWD,CAjDgB,EAkDhB0E,aAlDgB,CAkDF,MAAM;IACnBzH,OAAO,CAAC2F,qBAAD,CAAP;EACD,CApDgB,EAqDhB+B,WArDgB,CAqDJ,MAAM;IACjB;IACA;IACA7E,OAAO,CAACE,KAAR,GAAgB,KAAhB;IACA/C,OAAO,CAAC4F,mBAAD,CAAP;EACD,CA1DgB,CAAnB;EA4DA,IAAI3C,WAAJ,EAAiB8C,UAAU,CAAC4B,OAAX,CAAmB1E,WAAnB;;EACjB,IAAIG,sBAAJ,EAA4B;IAC1B,MAAMwE,YAAY,GAAG,CAAC,CAACxE,sBAAF,EAA0BA,sBAA1B,CAArB;;IACA,IAAI9B,KAAK,CAACgE,UAAV,EAAsB;MACpBS,UAAU,CAAC8B,aAAX,CAAyBD,YAAzB;IACD,CAFD,MAEO;MACL7B,UAAU,CAAC+B,aAAX,CAAyBF,YAAzB;IACD;EACF;;EAED,MAAMG,QAAQ,GAAG/G,iBAAiB,CAAEiB,YAAD,IAA0B;IAAA;;IAC3D,yBAAAX,KAAK,CAAC0G,oBAAN,qFAAA1G,KAAK,EAAwBW,YAAxB,CAAL;EACD,CAFiC,CAAlC;EAIA,MAAMgG,aAAa,GAAG/H,wBAAwB,CAC5C;IACE6H,QAAQ,EAAGjB,GAAD,IAAS;MACjB7E,YAAY,CAACc,KAAb,GAAqBX,cAAc,CAACW,KAAf,GACjB+D,GAAG,CAACoB,aAAJ,CAAkBC,CADD,GAEjBrB,GAAG,CAACoB,aAAJ,CAAkBE,CAFtB;MAGApI,OAAO,CAAC+H,QAAD,CAAP,CAAkB9F,YAAY,CAACc,KAA/B;IACD;EANH,CAD4C,EAS5C,CAACX,cAAD,CAT4C,CAA9C;EAYArB,aAAa;EAEb,MAAMsH,sBAAsB,GAAGrH,iBAAiB,CAE7CsH,IAAD,IAAU;IAAA;;IACV,MAAMC,eAAe,GAAGD,IAAI,CAACE,aAAL,CACrBC,MADqB,CACb9E,IAAD,IAAUA,IAAI,CAAC+E,UADD,EAErBzE,GAFqB,CAEhBN,IAAD,IAAUA,IAAI,CAACC,KAFE,EAGrB6E,MAHqB,CAGb7E,KAAD,IAA4B,OAAOA,KAAP,KAAiB,QAH/B,CAAxB;IAKA,MAAM+E,GAAG,GAAGC,IAAI,CAACD,GAAL,CAAS,GAAGJ,eAAZ,CAAZ;IACA,MAAMM,GAAG,GAAGD,IAAI,CAACC,GAAL,CAAS,GAAGN,eAAZ,CAAZ;IACA7F,gBAAgB,CAACK,KAAjB,GAAyB4F,GAAzB;IACAhG,gBAAgB,CAACI,KAAjB,GAAyB8F,GAAzB;IACA,yBAAAvH,KAAK,CAAC+G,sBAAN,qFAAA/G,KAAK,EAA0BgH,IAA1B,CAAL;EACD,CAb+C,CAAhD;EAeA,oBACE,oBAAC,yBAAD;IACE,SAAS,EAAEjF,SADb;IAEE,YAAY,EAAEK,YAFhB;IAGE,UAAU,EAAE,CAAC,CAACpC,KAAK,CAACgE,UAHtB;IAIE,uBAAuB,EAAEhC;EAJ3B,gBAME,oBAAC,eAAD;IAAiB,OAAO,EAAEyC;EAA1B,gBACE,oBAAC,QAAD,CAAU,IAAV;IACE,KAAK,EAAEzE,KAAK,CAACwH,cADf;IAEE,GAAG,EAAEtH,YAFP;IAGE,QAAQ,EAAEyD;EAHZ,GAKG3D,KAAK,CAACyH,iBAAN,iBACC,oBAAC,eAAD;IAAiB,iBAAiB,EAAEzH,KAAK,CAACyH;EAA1C,EANJ,eAQE,oBAAC,gBAAD,eACMzH,KADN;IAEE,IAAI,EAAEA,KAAK,CAACyC,IAFd;IAGE,sBAAsB,EAAEsE,sBAH1B;IAIE,qBAAqB,EAAEhI,qBAJzB;IAKE,GAAG,EAAEoB,WALP;IAME,mBAAmB,EAAE8D,uBANvB;IAOE,aAAa,EAAE,CAAClC,SAAD,IAAcH,aAP/B;IAQE,UAAU,EAAE4C,UARd;IASE,SAAS,EAAED,SATb;IAUE,YAAY,EAAEnC,YAVhB;IAWE,QAAQ,EAAEuE,aAXZ;IAYE,mBAAmB,EAAE,EAZvB;IAaE,oBAAoB,EAAE3G,KAAK,CAAC0H,oBAb9B;IAcE,qBAAqB,EAAE;EAdzB,GARF,EAwBG,CAAC,CAAC1H,KAAK,CAAC0G,oBAAR,iBACC,oBAAC,oBAAD;IACE,oBAAoB,EAAE1G,KAAK,CAAC0G,oBAD9B;IAEE,YAAY,EAAE/F;EAFhB,EAzBJ,CADF,CANF,CADF;AA0CD;;AAED,SAASgH,iBAAT,CACE3H,KADF,EAEE4H,GAFF,EAGE;EACA,oBACE,oBAAC,aAAD,EAAmB5H,KAAnB,eACE,oBAAC,qBAAD,qBACE,oBAAC,WAAD;IAAa,WAAW,EAAE4H;EAA1B,gBACE,oBAAC,aAAD,EAAmB5H,KAAnB,CADF,CADF,CADF,CADF;AASD;;AAED,MAAM6H,aAAa,GAAGjI,SAAS,CAACG,sBAAD,CAA/B,C,CAEA;AACA;;AACA,4BAAehC,KAAK,CAAC+J,UAAN,CAAiBH,iBAAjB,CAAf"}